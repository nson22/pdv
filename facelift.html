<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJ VARIEDADES | TUDO PARA SEU LAR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }

        #productList,
        #cartList,
        body {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #productList::-webkit-scrollbar,
        #cartList::-webkit-scrollbar,
        body::-webkit-scrollbar {
            display: none;
        }

        #productList,
        #cartList {
            height: 500px;
        }

        .product-cart-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 250px);
        }

        .product-cart-content {
            flex-grow: 1;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <header class="fixed-top bg-white py-3">
            <div class="container">
                <div class="mb-0 d-flex align-items-center justify-content-between">
                    <span class="navbar-brand text-danger fw-bold fs-4 d-block d-md-inline me-2">
                        PJ
                        <span
                            class="text-secondary fw-semibold text-uppercase text-warning d-md-inline">Variedades</span>
                    </span>
                    <button class="btn btn-success text-uppercase" id="finishPurchaseBtn" onclick="openPaymentModal()">
                        <i class="fas fa-shopping-cart"></i>
                        Fechar Compra
                        <span class="badge bg-light text-dark ms-1" id="cartBadge">0</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="mt-5 pt-5">
            <!-- Lista de Produtos e Carrinho -->
            <section class="row product-cart-container">
                <div class="col-lg-8 col-md-7 product-cart-content d-flex flex-column">
                    <div class="row align-items-center mb-3">
                        <div class="col-12 col-md-4 mb-2 mb-md-0">
                            <h2 class="mb-2 text-uppercase">Produtos</h2>
                        </div>
                        <div class="col-md-12 d-flex">
                            <div class="input-group">
                                <input type="search" id="searchInput" class="form-control" autocomplete="off"
                                    placeholder="Pesquisar produto por código, nome ou valor">
                            </div>
                            <div class="ms-2 col-md-auto">
                                <button class="btn btn-outline-success btn-small text-uppercase" data-bs-toggle="modal"
                                    data-bs-target="#customSaleModal">Avulsa<kbd
                                        class="ms-1 bg-secondary text-light">ALT +
                                        A</kbd> </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-grow-1 overflow-auto" id="productList">

                    </div>
                </div>

                <div class="col-lg-4 col-md-5 product-cart-content d-flex flex-column">
                    <div class="sticky-top bg-white d-flex justify-content-center align-items-center">
                        <h2 class="mb-0 text-uppercase">Itens no carrinho</h2>
                    </div>
                    <div class="flex-grow-1 overflow-auto">
                        <ul id="cartList" class="list-group mb-3">
                            <!-- Itens do carrinho serão adicionados aqui dinamicamente -->
                        </ul>
                    </div>
                    <div class="sticky-bottom bg-white py-3 border-top mt-auto">
                        <div class="row align-items-center">
                            <div class="col-12 mb-2">
                                <div class="form-group d-flex align-items-center">
                                    <div class="input-group">
                                        <span class="input-group-text fw-bold">Desconto</span>
                                        <input type="text" id="discountInput" class="form-control" placeholder="R$ 0,00"
                                            data-currency="BRL" autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="clearDiscountBtn"
                                            onclick="clearDiscount()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group d-flex align-items-center">
                                <div class="input-group">
                                    <span class="input-group-text fw-bold">Total</span>
                                    <input disabled type="text" id="cartTotal" class="form-control"
                                        placeholder="R$ 0,00" data-currency="BRL">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Modal para Venda Avulsa -->
            <div class="modal fade text-uppercase" id="customSaleModal" tabindex="-1"
                aria-labelledby="customSaleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold" id="customSaleModalLabel">Venda Avulsa</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="customSaleForm">
                                <div class="mb-3">
                                    <label for="customProductName" class="form-label">Nome do Produto</label>
                                    <input type="text" class="form-control" id="customProductName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="customProductPrice" class="form-label">Valor</label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="text" class="form-control" id="customProductPrice"
                                            data-currency="BRL" autocomplete="off" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger me-2" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success"
                                onclick="addCustomProduct()">Adicionar</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal de Pagamento -->
            <div class="modal fade text-uppercase" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold" id="paymentModalLabel">Finalizar Pagamento</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <!-- Lado esquerdo: Listagem de produtos -->
                                <div class="col-md-6">
                                    <h6 class="mb-3">Produtos no Carrinho</h6>
                                    <div style="max-height: 680px; overflow-y: auto;">
                                        <ul id="modalProductList" class="list-group">
                                            <!-- Os itens serão adicionados dinamicamente aqui -->
                                        </ul>
                                    </div>
                                </div>
                                <!-- Lado direito: Formulário de pagamento -->
                                <div class="col-md-6">
                                    <form id="paymentForm" autocomplete="off">
                                        <div class="row mb-3" id="payments">
                                            <div class="col-3 d-grid mx-auto"> <input type="radio" class="btn-check"
                                                    data-payment="PIX" data-testid="radioPix" name="payment-options"
                                                    id="pix-outlined" autocomplete="off" checked>
                                                <label class="btn btn-outline-secondary" for="pix-outlined"><i
                                                        class="fa-brands fa-pix"></i><br />PIX</label>
                                            </div>
                                            <div class="col-3 d-grid mx-auto"><input type="radio" class="btn-check"
                                                    data-payment="CREDITO" data-testid="radioCredit"
                                                    name="payment-options" id="credit-outlined" autocomplete="off">
                                                <label class="btn btn-outline-secondary" for="credit-outlined"><i
                                                        class="fa-solid fa-credit-card"></i><br />Crédito</label>
                                            </div>
                                            <div class="col-3 d-grid mx-auto"> <input type="radio" class="btn-check"
                                                    data-payment="DEBITO" data-testid="radioDebit"
                                                    name="payment-options" id="debit-outlined" autocomplete="off">
                                                <label class="btn btn-outline-secondary" for="debit-outlined"><i
                                                        class="fa-regular fa-credit-card"></i><br />Débito</label>
                                            </div>
                                            <div class="col-3 d-grid mx-auto"> <input type="radio" class="btn-check"
                                                    data-payment="DINHEIRO" data-testid="radioMoney"
                                                    name="payment-options" id="money-outlined" autocomplete="off">
                                                <label class="btn btn-outline-secondary" for="money-outlined"><i
                                                        class="fa-solid fa-brazilian-real-sign"></i><br />Dinheiro</label>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="totalAmount" class="form-label">Total da Compra</label>
                                                <input type="text" class="form-control form-control-lg" id="totalAmount"
                                                    placeholder="R$ 0,00" data-currency="BRL" disabled
                                                    autocomplete="off">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="discountAmount" class="form-label">Desconto Aplicado</label>
                                                <input type="text" class="form-control form-control-lg"
                                                    id="discountAmount" placeholder="R$ 0,00" data-currency="BRL"
                                                    disabled autocomplete="off">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="finalAmount" class="form-label">Valor Final</label>
                                                <input type="text" class="form-control form-control-lg" id="finalAmount"
                                                    placeholder="R$ 0,00" data-currency="BRL" disabled
                                                    autocomplete="off">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="paymentAmount" class="form-label">Valor Pago</label>
                                                <input type="text" class="form-control form-control-lg"
                                                    id="paymentAmount" placeholder="R$ 0,00" data-currency="BRL"
                                                    required autocomplete="off">
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-lg"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary btn-lg" id="confirmPayment"
                                onclick="handlePayment()">Confirmar
                                Pagamento</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer>
            <!-- Toast -->
            <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-danger text-white">
                        <strong class="me-auto">Notificação</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"
                            aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        <p id="toastMessage"></p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dados de exemplo (substitua por uma chamada de API real)
        let products = [];

        //Global Variables
        const cart = [];
        let discount = 0;

        //DOM Elements
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        const toast = new bootstrap.Toast('#liveToast');
        const toastMessage = document.getElementById('toastMessage');

        //DOM Events
        // Add event listener for window load
        window.addEventListener('load', () => {

            // Inicializar a exibição de produtos
            displayProducts(products);

            // Check if CART exists in localStorage and update the info
            const savedCart = localStorage.getItem('CART');
            if (savedCart) {
                // Parse the saved cart data
                const parsedCart = JSON.parse(savedCart);

                // Update the global cart variable
                cart.length = 0; // Clear the current cart
                cart.push(...parsedCart); // Add all items from saved cart

                // Update the cart display
                updateCart();

                // Update the cart badge
                updateCartBadge();

                console.log('Cart loaded from localStorage');
            } else {
                console.log('No saved cart found in localStorage');
            }

        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredProducts = products.filter(product =>
                product.code.toLowerCase().includes(searchTerm) ||
                product.name.toLowerCase().includes(searchTerm) ||
                product.price.toFixed(2).toString().includes(searchTerm)
            );
            displayProducts(filteredProducts);
        });

        // Adicionar evento para atualizar o desconto
        document.getElementById('discountInput').addEventListener('blur', (e) => {
            const discountValue = brazilianCurrencyToNumber(e.target.value);
            const currentTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            if (discountValue > currentTotal) {
                // Exibir toast com mensagem de erro
                showToast('O desconto não pode ser maior que o total da compra.', 'error');
                // Resetar o valor do desconto para 0
                e.target.value = '';
                e.target.placeholder = 'R$ 0,00';
                discount = 0;
            } else {
                discount = discountValue;
            }
            updateCart();
        });

        // Adicionar evento para formatar inputs com data-currency="BRL"
        document.querySelectorAll('[data-currency="BRL"]').forEach(input => {
            input.addEventListener('input', function (e) {
                let value = e.target.value;
                value = value.replace(/\D/g, "");
                value = (value / 100).toFixed(2) // Adiciona casas decimais
                    .replace(".", ",")           // Substitui ponto por vírgula
                    .replace(/\B(?=(\d{3})+(?!\d))/g, "."); // Adiciona separador de milhares
                e.target.value = value ? `R$ ${value}` : "";
            });
        });

        // Add event listener for Ctrl+K shortcut
        document.addEventListener('keydown', function (event) {
            if (event.altKey && event.code === 'KeyA') {
                const customSaleModal = new bootstrap.Modal(document.getElementById('customSaleModal'));
                customSaleModal.show(); // Open the avulsa modal
            }
        });

        function displayProducts(products) {
            const productList = document.getElementById('productList');

            productList.innerHTML = '';
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-responsive';
            tableContainer.style.maxHeight = '100%';
            tableContainer.style.overflow = 'auto';
            const table = document.createElement('table');
            table.className = 'table table-hover table-striped';
            table.innerHTML = `
                <thead class="sticky-top bg-light">
                    <tr>
                        <th>Código</th>
                        <th>Nome</th>
                        <th>Preço</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            tableContainer.appendChild(table);
            productList.appendChild(tableContainer);
            const tbody = table.querySelector('tbody');

            products.forEach(product => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-2"><kbd>${product.code}</kbd></td>
                    <td class="col-6"><span class="text-truncate" style="max-width: 200px; display: inline-block;">${product.name}</span></td>
                    <td class="col-2"><span class="fw-bold">${numberToBrazilianReal(product.price)}</span></td>
                    <td class="col-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="addToCart('${product.id}')">
                            Adicionar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function addToCart(productId) {
            const product = products.find(product => product.id === Number(productId));
            if (product) {
                const existingItem = cart.find(item => item.id === product.id);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({ ...product, quantity: 1 });
                }
                localStorage.setItem('CART', JSON.stringify(cart));
                updateCart();
                updateCartBadge();
            }
        }

        function updateCart() {
            const cartList = document.getElementById('cartList');
            const cartTotal = document.getElementById('cartTotal');
            cartList.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                const emptyCartMessage = document.createElement('div');
                emptyCartMessage.className = 'd-flex flex-column align-items-center justify-content-center h-100 text-center';
                emptyCartMessage.innerHTML = `
                    <div class="d-flex justify-content-center w-100">
                        <i class="fas fa-shopping-bag fa-10x text-muted opacity-50"></i>
                    </div>
                    <p class="mt-3 text-muted text-uppercase">Carrinho vazio</p>
                `;
                cartList.appendChild(emptyCartMessage);
            } else {
                cart.forEach(item => {
                    const subtotal = item.price * item.quantity;
                    total += subtotal;
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-action mt-2';
                    li.innerHTML = `
                        <div class="w-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-truncate me-2">Código:<kbd class="ms-2">${item.code}</kbd></span>
                                <button class="btn btn-danger btn-sm" onclick="removeFromCart('${item.code}')">
                                    Remover
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <h5 class="mb-0 text-truncate me-2">${item.name}</h5>
                                <input type="number" class="form-control form-control-sm" value="${item.quantity}" min="1" onchange="updateQuantity('${item.code}', this.value || 1)" style="width: 80px;">
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <p class="mb-0">Preço: ${numberToBrazilianReal(item.price)}</p>
                                <span class="fw-bold">Subtotal: ${numberToBrazilianReal(subtotal)}</span>
                            </div>
                        </div>
                    `;
                    cartList.appendChild(li);
                });
            }

            // Atualizar o total com o desconto
            const finalTotal = Math.max(total - discount, 0);
            cartTotal.value = numberToBrazilianReal(finalTotal)
            updateCartBadge();

            // Update localStorage CART
            localStorage.setItem('CART', JSON.stringify(cart));
        }

        function updateCartBadge() {
            const cartItemCount = document.getElementById('cartBadge');
            cartItemCount.textContent = cart.length;
        }

        function clearDiscount() {
            const discountInput = document.getElementById('discountInput');
            discountInput.value = '';
            discountInput.placeholder = 'R$ 0,00';
            discount = 0;
            updateCart();
        }

        function updateQuantity(code, newQuantity) {
            const item = cart.find(item => item.code === code);
            if (item) {
                item.quantity = parseInt(newQuantity);
                updateCart();
            }
        }

        function removeFromCart(code) {
            const index = cart.findIndex(item => item.code === code);
            if (index !== -1) {
                cart.splice(index, 1);
                updateCart();
                updateCartBadge();
            }
        }

        function addCustomProduct() {
            const customProductName = document.getElementById('customProductName').value.trim();
            const customProductPrice = brazilianCurrencyToNumber(document.getElementById('customProductPrice').value);

            if (customProductName && !isNaN(customProductPrice) && customProductPrice > 0) {
                const customProduct = {
                    code: `AVULSA(${Date.now()})`, // Generate a unique code
                    name: customProductName,
                    price: customProductPrice,
                    quantity: 1
                };

                cart.push(customProduct);
                updateCart();
                updateCartBadge();

                // Clear input fields
                document.getElementById('customProductName').value = '';
                document.getElementById('customProductPrice').value = '';

                // Show success message
                showToast('Produto personalizado adicionado com sucesso!', 'success');
            } else {
                // Show error message
                showToast('Por favor, insira um nome válido e um preço maior que zero.', 'error');
            }
        }

        function showToast(message, type) {
            toastMessage.textContent = message;
            const toastHeader = document.querySelector('.toast-header');
            const toastIcon = document.createElement('i');

            toastHeader.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');

            switch (type) {
                case 'success':
                    toastHeader.classList.add('bg-success');
                    toastIcon.className = 'fas fa-check-circle me-2';
                    break;
                case 'error':
                    toastHeader.classList.add('bg-danger');
                    toastIcon.className = 'fas fa-exclamation-circle me-2';
                    break;
                case 'warning':
                    toastHeader.classList.add('bg-warning');
                    toastIcon.className = 'fas fa-exclamation-triangle me-2';
                    break;
                default:
                    toastHeader.classList.add('bg-info');
                    toastIcon.className = 'fas fa-info-circle me-2';
            }

            // Remove existing icon if present
            const existingIcon = toastHeader.querySelector('i');
            if (existingIcon) {
                existingIcon.remove();
            }

            toastHeader.prepend(toastIcon);
            toast.show();
        }

        function numberToBrazilianReal(number) {
            return number.toLocaleString("pt-BR", {
                style: "currency",
                currency: "BRL",
            });
        }

        function brazilianCurrencyToNumber(currency) {
            if (!currency.includes("R$")) {
                currency = `R$ ${currency}`
            }
            let cleanValue = currency.replace("R$", "").trim();
            cleanValue = cleanValue.replace(/\./g, "");
            cleanValue = cleanValue.replace(",", ".");
            return parseFloat(cleanValue);
        }

        function openPaymentModal() {
            // Check if cart is empty
            if (cart.length === 0) {
                showToast('O carrinho está vazio. Adicione itens antes de prosseguir com o pagamento.', 'error');
                return;
            }

            // Reset payment form
            document.getElementById('paymentForm').reset();

            // Update total amount
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0) - discount;
            document.getElementById('totalAmount').value = numberToBrazilianReal(total);

            // Update discount amount
            document.getElementById('discountAmount').value = numberToBrazilianReal(discount);

            // Populate modal product list
            const modalProductList = document.getElementById('modalProductList');
            modalProductList.innerHTML = '';
            cart.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <h6 class="my-0">${item.name}</h6>
                        <small class="text-muted">${item.quantity}x ${numberToBrazilianReal(item.price)}</small>
                    </div>
                    <span class="text-muted">${numberToBrazilianReal(item.price * item.quantity)}</span>
                `;
                modalProductList.appendChild(li);
            });

            // Add discount item if applicable
            if (discount > 0) {
                const discountLi = document.createElement('li');
                discountLi.className = 'list-group-item d-flex justify-content-between bg-light';
                discountLi.innerHTML = `
                    <div class="text-success">
                        <h6 class="my-0">Desconto</h6>
                    </div>
                    <span class="text-success">-${numberToBrazilianReal(discount)}</span>
                `;
                modalProductList.appendChild(discountLi);
            }

            // Add total item
            const totalLi = document.createElement('li');
            totalLi.className = 'list-group-item d-flex justify-content-between';
            totalLi.innerHTML = `
                <span>Total (BRL)</span>
                <strong>${numberToBrazilianReal(total)}</strong>
            `;
            modalProductList.appendChild(totalLi);

            // Show the modal
            paymentModal.show();
        }

        async function handlePayment() {
            debugger
            const paymentAmountPayed = document.getElementById('paymentAmount');
            const paymentTotalEl = document.getElementById('totalAmount');
            const totalAmount = brazilianCurrencyToNumber(paymentTotalEl.value);

            if (Number(paymentAmountPayed.value) <= 0 || isNaN(totalAmount)) {
                paymentAmountPayed.classList.add('border-danger');
                paymentAmountPayed.classList.add('is-invalid');
                paymentAmountPayed.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
                paymentAmountPayed.focus();
                return;
            }

            let id = Date.now();
            const paymentDiscount = document.getElementById('discountAmount');
            let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            let isInstallments = false;

            if (!isInstallments) {
                paymentTotalEl.value = numberToBrazilianReal(total);
            }

            const payment = {
                id,
                products: cart.map(product => ({
                    code: product.code,
                    name: product.name,
                    quantity: product.quantity,
                    price: product.price
                })),
                discount: brazilianCurrencyToNumber(paymentDiscount.value) || 0
            };

            let amountPayed = brazilianCurrencyToNumber(paymentAmountPayed.value);

            if (payment.discount > 0) {
                total -= payment.discount;
                paymentTotalEl.value = numberToBrazilianReal(total);
            }

            if (amountPayed > total) {
                showToast("O valor de pagamento excede o valor da venda, portanto o valor foi ajustado.", "info");
                paymentAmountPayed.value = numberToBrazilianReal(total);
                amountPayed = total;
                return;
            }

            if (total === amountPayed) {
                let paymentType = addPaymentMethod();

                payment.paymentsMethods = [
                    {
                        id,
                        paymentType,
                        amountPayed
                    }
                ];

                await postPayment(payment);
                clearCart();
                paymentModal.hide();
                return;
            }

            if (total > amountPayed) {
                isInstallments = true;

                let remainingAmount = total - amountPayed;
                let paymentType = addPaymentMethod();

                payment.paymentsMethods = [
                    {
                        id,
                        paymentType,
                        amountPayed
                    }
                ];

                while (remainingAmount > 0) {
                    paymentTotalEl.value = numberToBrazilianReal(remainingAmount);
                    paymentAmountPayed.value = "";
                    modalPayment.show();

                    await new Promise(resolve => {
                        const confirmButton = document.querySelector("#confirmPayment");
                        confirmButton.addEventListener("click", resolve, { once: true });
                    });

                    let partialPayment = brazilianCurrencyToNumber(paymentAmountPayed.value);

                    if (partialPayment > remainingAmount) {
                        showToast("O valor de pagamento excede o valor restante, portanto o valor foi ajustado.", "info");
                        partialPayment = remainingAmount;
                    }

                    remainingAmount -= partialPayment;

                    paymentType = addPaymentMethod();

                    payment.paymentsMethods.push({
                        id,
                        paymentType,
                        amountPayed: partialPayment
                    });
                }

                // await postPayment(payment);
                console.log("payment", payment);
                clearCart();
                paymentModal.hide();
                return;
            }
        }

        // Function to initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ProductsDB', 4);

                request.onerror = (event) => reject("IndexedDB error: " + event.target.error);

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        const objectStore = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('code', 'code', { unique: false });
                        objectStore.createIndex('name', 'name', { unique: false });
                        objectStore.createIndex('price', 'price', { unique: false });
                    }
                };
            });
        }

        // Function to save products to IndexedDB
        function saveProductsToDB(db, products) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['products'], 'readwrite');
                const objectStore = transaction.objectStore('products');

                products.forEach(product => {
                    objectStore.put(product);
                });

                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => reject("Error saving products: " + event.target.error);
            });
        }

        // Function to load products from IndexedDB
        function loadProductsFromDB(db) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['products'], 'readonly');
                const objectStore = transaction.objectStore('products');
                const request = objectStore.getAll();

                request.onsuccess = (event) => {
                    products = event.target.result;
                    resolve(products);
                };

                request.onerror = (event) => reject("Error loading products: " + event.target.error);
            });
        }

        // Initialize the database and load or generate products
        initDB().then(db => {
            loadProductsFromDB(db).then(loadedProducts => {
                if (loadedProducts.length === 0) {
                    // If no products in DB, generate them
                    products = Array.from({ length: 1500 }, (_, i) => {
                        const id = Date.now() + i;
                        const code = (i + 1).toString().padStart(3, '0');
                        const name = `Produto ${['Pequeno', 'MédioMédioMédioMédio', 'GrandeGrandeGrandeGrandeGrandeGrandeGrandeGrandeGrandeGrandeGrandeGrande'][i % 3]} ${String.fromCharCode(65 + i)}`;
                        const price = 10.1 + i * 5.5;
                        return { id, code, name, price: Number(price.toFixed(2)) };
                    });
                    // Save generated products to DB
                    saveProductsToDB(db, products).then(() => {
                        console.log("Products saved to IndexedDB");
                        displayProducts(products);
                    });
                } else {
                    console.log("Products loaded from IndexedDB");
                    displayProducts(loadedProducts);
                }
                updateCart(); // Adicione esta linha para mostrar o ícone do carrinho vazio ao carregar a página
            });
        }).catch(error => console.error("Database initialization error:", error));


    </script>
</body>

</html>