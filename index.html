<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }

    img {
      max-width: 3%;
      height: auto;
    }

    .shimmer {
      border-radius: 6px;
      position: relative;
      overflow: hidden;
      background: #6c757d;
      background: linear-gradient(to right, #6c757d 0%, #7d868e 20%, #6c757d 40%, #6c757d 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite linear;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }
  </style>
</head>

<body>
  <div class="ms-5">
    <header class="fixed-top bg-light px-5 py-2 w-100">
      <div class="d-flex align-items-center justify-content-between">
        <img src="https://i.postimg.cc/Y9pv6ZLR/pjlogo.jpg" alt="pjlogo">
        <span class="navbar-brand text-danger fw-bold fs-1 d-block d-md-inline text-uppercase"
          style="font-family: 'Montserrat', sans-serif;">PJ
          <span class="text-secondary fw-semibold text-warning d-md-inline text-uppercase">Variedades</span>
        </span>
        <button class="btn btn-primary text-uppercase" id="finishPurchaseBtn" onclick="openPaymentModal()">
          Fechar Venda
        </button>
      </div>
    </header>

    <main class="mt-5 pt-5 d-flex flex-column" style="height: calc(100vh - 0px - 125px); overflow: hidden;">
      <!-- Lista de Produtos e Carrinho -->
      <section class="row flex-grow-1 overflow-hidden h-100">
        <div class="col-lg-8 col-md-7 d-flex flex-column h-100">
          <div class="row align-items-center mb-3">
            <div class="col-12 col-md-4 mb-2 mb-md-0">
              <h2 class="mb-2 text-uppercase p-2">Produtos</h2>
            </div>
            <div class="col-md-12 d-flex">
              <div class="input-group">
                <input type="search" id="searchInput" class="form-control" autocomplete="off"
                  placeholder="Pesquisar produto por código ou nome">
              </div>
              <div class="ms-2 col-md-auto">
                <button class="btn btn-primary btn-small text-uppercase" data-bs-toggle="modal"
                  data-bs-target="#customSaleModal">Avulsa</button>
              </div>
            </div>
          </div>
          <div class="flex-grow-1 overflow-auto" id="productList">
            <!-- Produtos serão adicionados aqui dinamicamente -->
            <div class="table-responsive" style="max-height: 100%; overflow: auto;">
              <table class="table table-hover table-striped">
                <thead class="sticky-top bg-light">
                  <tr>
                    <th scope="col" class="text-uppercase">Produto</th>
                    <th scope="col" class="text-uppercase">Preço</th>
                    <th scope="col" class="text-uppercase">Estoque</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>

                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-4 col-md-5 d-flex flex-column h-100 px-5">
          <div class="sticky-top bg-white d-flex justify-content-center align-items-center">
            <h2 class="mb-0 text-center text-uppercase p-2">
              Carrinho<span class="badge bg-secondary ms-3" id="cartBadge">0</span></h2>
          </div>
          <div class="flex-grow-1 overflow-auto">
            <ul id="cartList" class="list-group mb-3">
              <!-- Itens do carrinho serão adicionados aqui dinamicamente -->
            </ul>
          </div>
          <div class="sticky-bottom bg-white pt-1 border-top px-1">
            <div class="row align-items-center">
              <div class="col-12 mt-1 mb-1">
                <div class="form-group d-flex align-items-center">
                  <div class="input-group">
                    <span class="input-group-text fw-bold text-uppercase">Desconto</span>
                    <input type="search" id="discountInput" inputmode="decimal" class="form-control form-control-lg"
                      placeholder="R$ 0,00" data-currency="BRL" autocomplete="off">
                  </div>
                </div>
              </div>
              <div class="col-12 mt-1 mb-1">
                <div class="form-group d-flex align-items-center">
                  <div class="input-group">
                    <span class="input-group-text fw-bold text-danger text-uppercase fs-1">Total</span>

                    <input disabled type="text" id="cartTotal"
                      class="form-control form-control-lg text-danger fw-bold fs-1" placeholder="R$ 0,00"
                      data-currency="BRL">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <footer class="fixed-bottom bg-light p4 mt-1">
      <div class="shortcut-helpers p-4">
        <div class="ms-5">
          <div class="row">
            <div class="col">
              <kbd>F1</kbd> - <small>Buscar produto</small>
            </div>
            <div class="col">
              <kbd>F2</kbd> - <small>Vanda avulsa</small>
            </div>
            <div class="col">
              <kbd>F3</kbd> - <small>Fechar venda</small>
            </div>
            <div class="col">
              <kbd>F4</kbd> - <small>Desconto</small>
            </div>
            <div class="col">
              <kbd>F11</kbd> - <small>Abrir/Fechar tela cheia</small>
            </div>
          </div>
        </div>
    </footer>
    <!-- Modal para Venda Avulsa -->
    <div class="modal fade" id="customSaleModal" tabindex="-1" aria-labelledby="customSaleModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold text-uppercase" id="customSaleModalLabel">Venda Avulsa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="customSaleForm">
              <div class="mb-3">
                <label for="customProductName" class="form-label text-uppercase">Nome do Produto</label>
                <input type="text" class="form-control" id="customProductName" required>
              </div>
              <div class="mb-3">
                <label for="customProductPrice" class="form-label text-uppercase">Valor</label>
                <div class="input-group">
                  <span class="input-group-text">R$</span>
                  <input type="text" class="form-control" id="customProductPrice" data-currency="BRL" autocomplete="off"
                    required>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger me-2" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-success" onclick="addCustomProduct()">Adicionar</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal para Venda com metragem -->
    <div class="modal fade" id="unitModal" tabindex="-1" aria-labelledby="unitModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold text-uppercase" id="unitModalLabel">Venda com metragem</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-6 mb-3">
                <label for="unitSaleName" class="form-label text-uppercase">Nome do Produto</label>
                <input type="text" class="form-control" id="unitSaleName" required disabled>
              </div>
              <div class="col-6 mb-3">
                <label for="unitSaleAvailability" class="form-label text-uppercase">QTD Disponível</label>
                <input type="text" class="form-control" id="unitSaleAvailability" required disabled>
              </div>
              <div class="col-6 mb-3">
                <label for="unitSalePrice" class="form-label text-uppercase">Valor</label>
                <div class="input-group">
                  <span class="input-group-text">R$</span>
                  <input type="text" class="form-control" id="unitSalePrice" data-currency="BRL" autocomplete="off"
                    disabled required>
                </div>
              </div>
              <div class="col-6">
                <label for="uniteSaleAmont" class="form-label text-uppercase">QTD</label>
                <div class="input-group">
                  <span class="input-group-text">Metros</span>
                  <input type="number" min="0.1" step="0.1" class="form-control" id="uniteSaleAmont" autocomplete="off"
                    required>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger me-2" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-success" onclick="addUnitProduct()">Adicionar</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal de Pagamento -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content p-3">
          <div class="modal-header">
            <h5 class="modal-title fw-bold text-uppercase" id="paymentModalLabel">Finalizar Venda</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="overflow-y: hidden;">
            <div class="row">
              <!-- Lado esquerdo: Listagem de produtos -->
              <div class="col-md-6">
                <div style="overflow-y: auto; max-height: calc(99vh - 200px);">
                  <ul id="modalProductList" class="list-group list-group-flush">
                    <!-- Os itens serão adicionados dinamicamente aqui -->
                  </ul>
                </div>
              </div>
              <!-- Lado direito: Formulário de pagamento -->
              <div class="col-md-6">
                <form id="paymentForm" autocomplete="off">
                  <div class="row mb-3" id="payments">
                    <div class="col-3 d-grid mx-auto"> <input type="radio" class="btn-check" data-payment="PIX"
                        data-testid="radioPix" name="payment-options" id="pix-outlined" autocomplete="off" checked>
                      <label class="btn btn-outline-primary" for="pix-outlined"><i
                          class="fa-brands fa-pix"></i><br />PIX</label>
                    </div>
                    <div class="col-3 d-grid mx-auto"><input type="radio" class="btn-check" data-payment="CREDITO"
                        data-testid="radioCredit" name="payment-options" id="credit-outlined" autocomplete="off">
                      <label class="btn btn-outline-primary" for="credit-outlined"><i
                          class="fa-solid fa-credit-card"></i><br />Crédito</label>
                    </div>
                    <div class="col-3 d-grid mx-auto"> <input type="radio" class="btn-check" data-payment="DEBITO"
                        data-testid="radioDebit" name="payment-options" id="debit-outlined" autocomplete="off">
                      <label class="btn btn-outline-primary" for="debit-outlined"><i
                          class="fa-regular fa-credit-card"></i><br />Débito</label>
                    </div>
                    <div class="col-3 d-grid mx-auto"> <input type="radio" class="btn-check" data-payment="DINHEIRO"
                        data-testid="radioMoney" name="payment-options" id="money-outlined" autocomplete="off">
                      <label class="btn btn-outline-primary" for="money-outlined"><i
                          class="fa-solid fa-brazilian-real-sign"></i><br />Dinheiro</label>
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="totalAmount" class="form-label text-uppercase fw-bold">Total</label>
                      <input type="text" class="form-control form-control-lg" id="totalAmount" name="totalAmount"
                        placeholder="R$ 0,00" data-currency="BRL" disabled autocomplete="off">
                    </div>
                    <div class="col-md-6">
                      <label for="discountAmount" class="form-label text-uppercase fw-bold">Desconto</label>
                      <input type="text" class="form-control form-control-lg" id="discountAmount" name="discountAmount"
                        placeholder="R$ 0,00" data-currency="BRL" disabled autocomplete="off">
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="paidAmount" class="form-label text-uppercase fw-bold">Valor Pago</label>
                      <input type="text" inputmode="numeric" class="form-control form-control-lg" name="paidAmount"
                        id="paidAmount" placeholder="R$ 0,00" data-currency="BRL" autocomplete="off">
                    </div>
                    <div class="col-md-6">
                      <label for="changeAmount" class="form-label text-uppercase fw-bold">Troco</label>
                      <input type="text" class="form-control form-control-lg" id="changeAmount" disabled
                        placeholder="R$ 0,00" data-currency="BRL" readonly>
                    </div>
                    <div class="col-md-12 mt-3">
                      <!-- <label class="form-label">Pagamentos Parciais</label> -->
                      <ul class="list-group list-group-flush" id="partialPaymentsList">
                        <!-- Partial payments will be added here dynamically -->
                      </ul>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger btn-lg" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary btn-lg" id="confirmPayment"
              onclick="handlePayment()">Confirmar</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Toast -->
    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
          <strong class="me-auto">Mensagem</strong>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          <p id="toastMessage"></p>
        </div>
      </div>
    </div>
    <div class="modal fade" id="loadingModal" aria-hidden="true" aria-labelledby="loadingModalLabel" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mt-3">Carregando...</h5>
            <p>Por favor, aguarde enquanto processamos a venda.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    //Global Variables
    let dbProducts = []
    let cart = [];
    let discount = 0;
    let totalToPay = 0

    //DOM Elements
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    const toast = new bootstrap.Toast('#liveToast');
    const toastMessage = document.getElementById('toastMessage');
    const customSaleModal = new bootstrap.Modal(document.getElementById('customSaleModal'));
    const modalProductList = document.getElementById('modalProductList');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    const unitModal = new bootstrap.Modal(document.getElementById('unitModal'));

    //DOM Events
    document.addEventListener('keydown', function (event) {
      switch (event.key) {
        case 'F1':
          event.preventDefault();
          document.getElementById('searchInput').focus();
          break;
        case 'F2':
          event.preventDefault();
          customSaleModal.show()
          break;
        case 'F3':
          event.preventDefault();
          if (document.activeElement === document.getElementById("discountInput")) {
            document.getElementById("discountInput").blur();
          }
          openPaymentModal();

          break;
        case 'F4':
          event.preventDefault();
          document.getElementById("discountInput").focus()
          break;
        default:
          break;
      }

    });

    // Add event listener for window load
    window.addEventListener('load', () => {
      // Inicializar a exibição de produtos

      fetchProducts()
      if (window.location.hostname === '127.0.0.1') {
        const localProducts = [
          { id: '1', code: '001', name: 'Produto Local 1', price: 10.00, stock: 100, unit: 'M' },
          { id: '2', code: '002', name: 'Produto Local 2', price: 20.00, stock: 200, unit: 'M' },
          { id: '3', code: '003', name: 'Produto Local 3', price: 30.00, stock: 300, unit: 'M' },
        ];
        localStorage.setItem('PRODUCTS', JSON.stringify(localProducts));
        dbProducts = localProducts;
        displayProducts(localProducts);
        openPaymentModal();
      }
      const savedCart = localStorage.getItem('CART');
      if (savedCart) {
        const parsedCart = JSON.parse(savedCart);
        cart.length = 0;
        cart.push(...parsedCart);
        updateShoppingCart();
        updateCartBadge();
      }

    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toUpperCase();
      const filteredProducts = dbProducts.filter(product =>
        String(product.code).includes(searchTerm) ||
        product.name.toUpperCase().includes(searchTerm)
      );
      displayProducts(filteredProducts);
    });

    // Adicionar evento para atualizar o desconto
    document.getElementById('discountInput').addEventListener('blur', (e) => {

      const discountValue = brazilianCurrencyToNumber(e.target.value);
      const currentTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

      if (discountValue > currentTotal) {
        // Exibir toast com mensagem de erro
        showToast('O desconto não pode ser maior que o total da compra.', 'error');
        // Resetar o valor do desconto para 0
        e.target.value = '';
        e.target.placeholder = 'R$ 0,00';
        discount = 0;
      } else {
        discount = discountValue;
      }
      updateShoppingCart();
    });

    document.getElementById('discountInput').addEventListener('input', function (event) {
      if (cart.length === 0) {
        event.target.value = '';
        showToast('Não é possível aplicar desconto em um carrinho vazio.', 'error');
        return
      }
    });

    // Adicionar evento para formatar inputs com data-currency="BRL"
    document.querySelectorAll('[data-currency="BRL"]').forEach(input => {
      input.addEventListener('input', function (e) {
        let value = e.target.value;
        value = value.replace(/\D/g, "");
        value = (value / 100).toFixed(2) // Adiciona casas decimais
          .replace(".", ",")           // Substitui ponto por vírgula
          .replace(/\B(?=(\d{3})+(?!\d))/g, "."); // Adiciona separador de milhares
        e.target.value = value ? `R$ ${value}` : "";
      });
    });

    // Add event listener for Ctrl+K shortcut
    document.addEventListener('keydown', function (event) {
      if (event.altKey && event.code === 'KeyA') {
        customSaleModal.show(); // Open the avulsa modal
      }
    });

    // Add event listener for change calculation
    document.getElementById('paidAmount').addEventListener('input', function (e) {
      const paidAmount = brazilianCurrencyToNumber(e.target.value);
      const totalAmount = brazilianCurrencyToNumber(document.getElementById('totalAmount').value);

      if (paidAmount > totalAmount) {
        const change = paidAmount - totalAmount;
        document.getElementById('changeAmount').value = numberToBrazilianCurrency(change);
      } else {
        document.getElementById('changeAmount').value = 'R$ 0,00';
      }
    });

    document.getElementById('paidAmount').addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        handlePayment();
      }
    });

    // Add event listener for Enter key to blur input fields
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          input.blur();
        }
      });
    });

    // Add event listener to focus on customProductName when customSaleModal is shown
    document.getElementById('customSaleModal').addEventListener('shown.bs.modal', function () {
      document.getElementById('customProductName').focus();
    });

    document.getElementById('customProductName').addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        this.blur();
        document.getElementById('customProductPrice').focus();
      }
    });

    document.getElementById('customProductPrice').addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        addCustomProduct();
      }
    });

    document.getElementById('paymentModal').addEventListener('hidden.bs.modal', function () {
      document.getElementById('modalProductList').innerHTML = '';
      document.getElementById('partialPaymentsList').innerHTML = '';
    });


    //Fim eventos

    function fetchProducts() {
      loadingShimmer();

      new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getProducts()
      }).then(products => {
        dbProducts = [...products]
        displayProducts(products);
      }).catch(error => {
        showToast('Erro ao buscar produtos, tente novamente.', 'error');
      });
    }

    function displayProducts(products) {
      const tbody = document.querySelector('tbody');
      tbody.innerHTML = ''

      products.forEach(product => {
        let badgeBgColor = 'bg-secondary';

        if (product.code === 'SEM CADASTRO') {
          badgeBgColor = 'bg-danger';
        }

        const tr = document.createElement('tr');

        tr.innerHTML = `
                  <td>
                      <p class="d-inline-block text-truncate" style="max-width: 450px;">
                          <small class="badge ${badgeBgColor}">${product.code}</small></br>
                          ${product.name}
                      </p>
                  </td>
                  <td class="align-middle">
                      <span class="text-nowrap">${numberToBrazilianCurrency(product.price)}</span>
                  </td>
                  <td class="align-middle">
                      <span class="text-nowrap" id="stock-${product.id}">${product.stock}<small>${product.unit}</small></span>
                  </td>
                  <td class="align-middle">
                      <button type="button" class="btn btn-outline-primary btn-sm text-uppercase"
                          onclick="addToCart('${product.id}')"
                          aria-label="Add ${product.name} to Cart">
                          Adicionar
                      </button>
                  </td>
                `;
        tbody.appendChild(tr);
      });
    }

    function addToCart(productId) {
      const product = dbProducts.find(product => product.id == productId);

      if (product) {
        const existingItem = cart.find(item => item.id === product.id);

        if (product.unit === 'M') {
          document.getElementById('unitSaleName').value = product.name
          document.getElementById('unitSaleAvailability').value = product.stock
          document.getElementById('unitSalePrice').value = numberToBrazilianCurrency(product.price)
          unitModal.show()
          

        } else if (existingItem) {
          existingItem.quantity += 1;

        } else {
          cart.push({ ...product, quantity: 1 });
        }

        product.stock -= 1;
        document.getElementById(`stock-${product.id}`).textContent = product.stock;

        localStorage.setItem('CART', JSON.stringify(cart));
        updateShoppingCart();
      }
    }

    function updateShoppingCart() {
      const cartList = document.getElementById('cartList');
      const cartTotal = document.getElementById('cartTotal');
      cartList.innerHTML = '';
      let total = 0;

      if (cart.length === 0) {
        const emptyCartMessage = document.createElement('div');
        emptyCartMessage.className = 'd-flex flex-column align-items-center justify-content-center h-100 text-center';
        emptyCartMessage.innerHTML = `
                    <div class="d-flex justify-content-center w-100 mt-5">
                        <i class="fas fa-shopping-bag fa-10x opacity-50 p-5 text-danger"></i>
                    </div>
                    <p class="mt-3 text-muted text-uppercase">Carrinho vazio</p>
                `;
        cartList.appendChild(emptyCartMessage);
      } else {
        cart.forEach(product => {
          let badgeBgColor = 'bg-secondary';

          if (product.code === 'SEM CADASTRO') {
            badgeBgColor = 'bg-danger';
          }
          const subtotal = product.price * product.quantity;
          total += subtotal;
          const li = document.createElement('li');
          li.className = 'list-group-item list-group-item-action mt-2';
          li.innerHTML = `
                        <div class="w-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-truncate me-2">Código: <span class="badge ${badgeBgColor}">${product.code}</span></span>
                                <button class="btn btn-danger btn-sm" onclick="removeFromCart('${product.id}')">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="mb-0 text-truncate me-2">${product.name}</span>
                                <input type="number" class="form-control form-control-sm" value="${product.quantity}" min="1" onchange="updateQuantity('${product.code}', this.value || 1)" style="width: 80px;">
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <p class="mb-0">Preço: ${numberToBrazilianCurrency(product.price)}</p>
                                <span class="fw-bold">Subtotal: ${numberToBrazilianCurrency(subtotal)}</span>
                            </div>
                        </div>
                    `;
          cartList.appendChild(li);
        });
        updateCartBadge();
      }

      // Atualizar o total com o desconto
      const finalTotal = Math.max(total - discount, 0);
      cartTotal.value = numberToBrazilianCurrency(finalTotal)
      updateCartBadge();

      // Update localStorage CART
      localStorage.setItem('CART', JSON.stringify(cart));
    }

    function updateCartBadge() {
      const cartItemCount = document.getElementById('cartBadge');
      cartItemCount.textContent = cart.length;
    }

    function updateQuantity(code, newQuantity) {
      const item = cart.find(item => item.code === code);
      const product = dbProducts.find(product => product.code === code);
      if (item && product) {
        const oldQuantity = item.quantity;
        const quantityDifference = newQuantity - oldQuantity;

        // Update the cart item quantity
        item.quantity = parseInt(newQuantity);

        // Update the product stock
        product.stock -= quantityDifference;
        document.getElementById(`stock-${product.id}`).textContent = product.stock;

        updateShoppingCart();
      }
    }

    function removeFromCart(id) {
      const index = cart.findIndex(item => item.id == id);
      if (index !== -1) {
        const removedItem = cart.splice(index, 1)[0];

        // Return the quantity back to the product stock
        const product = dbProducts.find(product => product.id == id);
        if (product) {
          product.stock += removedItem.quantity;
          document.getElementById(`stock-${product.id}`).textContent = product.stock;
        }

        updateShoppingCart();
        updateCartBadge();
      }
    }

    function addCustomProduct() {
      const customProductName = document.getElementById('customProductName').value.trim();
      const customProductPrice = brazilianCurrencyToNumber(document.getElementById('customProductPrice').value);
      let id = Date.now()

      if (customProductName && !isNaN(customProductPrice) && customProductPrice > 0) {
        const customProduct = {
          id,
          code: `SEM CADASTRO`, // Generate a unique code
          name: customProductName.toUpperCase(),
          price: customProductPrice,
          quantity: 1
        };

        cart.push(customProduct);
        updateShoppingCart();
        updateCartBadge();

        // Clear input fields
        document.getElementById('customProductName').value = '';
        document.getElementById('customProductPrice').value = '';
        customSaleModal.hide()
      } else {
        // Show error message
        showToast('Por favor, insira um nome válido e um preço maior que zero.', 'error');
      }
    }

    function showToast(message, type) {
      toastMessage.textContent = message;
      const toastHeader = document.querySelector('.toast-header');
      const toastIcon = document.createElement('i');

      toastHeader.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');

      switch (type) {
        case 'success':
          toastHeader.classList.add('bg-success');
          toastIcon.className = 'fas fa-check-circle me-2';
          break;
        case 'error':
          toastHeader.classList.add('bg-danger');
          toastIcon.className = 'fas fa-exclamation-circle me-2';
          break;
        case 'warning':
          toastHeader.classList.add('bg-warning');
          toastIcon.className = 'fas fa-exclamation-triangle me-2';
          break;
        default:
          toastHeader.classList.add('bg-info');
          toastIcon.className = 'fas fa-info-circle me-2';
      }

      // Remove existing icon if present
      const existingIcon = toastHeader.querySelector('i');
      if (existingIcon) {
        existingIcon.remove();
      }

      toastHeader.prepend(toastIcon);
      toast.show();
    }

    function numberToBrazilianCurrency(number) {
      return parseFloat(number).toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
      });
    }

    function brazilianCurrencyToNumber(currency) {
      if (!currency.includes("R$")) {
        currency = `R$ ${currency}`
      }

      let cleanValue = currency.replace("R$", "").trim();
      cleanValue = cleanValue.replace(/\./g, "");
      cleanValue = cleanValue.replace(",", ".");
      return parseFloat(cleanValue);
    }

    function openPaymentModal() {
      document.getElementById('paidAmount').focus()
      if (cart.length === 0) {
        showToast('O carrinho está vazio. Adicione itens antes de prosseguir com a venda.', 'error');
        return;
      }

      if (toast._element.classList.contains('show')) return;

      document.getElementById('paymentForm').reset();

      const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0) - discount;
      document.getElementById('totalAmount').value = numberToBrazilianCurrency(total);
      document.getElementById('discountAmount').value = numberToBrazilianCurrency(discount);

      modalProductList.innerHTML = '';
      cart.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center w-100">
                      <div class="d-flex flex-column">
                        <small class="badge bg-secondary">${item.code}</small>
                        <small class="my-1 text-truncate" style="max-width: 500px;" title="${item.name}">${item.name}</small>
                        <small class="text-muted">${item.quantity}x ${numberToBrazilianCurrency(item.price)}</small>
                      </div>
                      <span class="text-danger fw-bold">${numberToBrazilianCurrency(item.price * item.quantity)}</span>
                    </div>
                `;
        modalProductList.appendChild(li);
      });

      paymentModal.show();
    }

    function getPaymentMethod() {
      let paymentMethods = document.querySelectorAll(`[data-testid*="radio"]`);
      let checkedRadio = Array.from(paymentMethods).find(radio => radio.checked);
      return checkedRadio ? checkedRadio.dataset.payment || null : null;
    }

    function handlePayment() {
      const totalAmountEl = document.getElementById('totalAmount')
      const discountAmountEl = document.getElementById('discountAmount')
      const paidAmountEl = document.getElementById('paidAmount')
      const changeAmountEl = document.getElementById('changeAmount')

      if (!paidAmountEl.value.trim()) {
        showToast('Por favor, insira o valor para pagamento.', 'error');
        return;
      }

      let paidAmount = brazilianCurrencyToNumber(paidAmountEl.value)
      let totalAmount = brazilianCurrencyToNumber(totalAmountEl.value)
      let discountAmount = brazilianCurrencyToNumber(discountAmountEl.value)

      if (paidAmount < totalAmount) {
        updatePaymentMethodList(getPaymentMethod(), paidAmount);
        paidAmountEl.value = '';
        const newTotalAmount = totalAmount - paidAmount;
        totalAmountEl.value = numberToBrazilianCurrency(newTotalAmount)
        return;
      }

      updatePaymentMethodList(getPaymentMethod(), paidAmount);
      paidAmountEl.value = '';
      const newTotalAmount = totalAmount - paidAmount;
      totalAmountEl.value = ''

      let methodsPaid = Array.from(document.querySelectorAll('#paymentType')).map(el => el.innerText);
      let amountPaid = Array.from(document.querySelectorAll('#amountPaid')).map(el => el.innerText);

      let paymentMethods = methodsPaid.map((method, index) => ({
        method,
        amount: amountPaid[index]
      }));

      let products = cart.map(product => ({
        code: product.code,
        name: product.name,
        quantity: product.quantity,
        price: product.price
      }));

      let formData = {
        id: Date.now(),
        products,
        discountAmount,
        paymentMethods
      };

      console.log("Form Data:", formData);

      loadingModal.show();
      postPayment(formData)

      updatePaymentMethodList("", 0, true);
    }

    function postPayment(paymentData) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .postPaymentGAS(paymentData);
      }).then(response => {
        console.log('Response:', response);
        showToast('Venda finalizada com sucesso!', 'success');
        clearCart();
        paymentModal.hide();
      }).catch(error => {
        console.error('Error:', error);
        showToast('Erro ao finalizar a venda. Tente novamente.', 'error');
      }).finally(() => {
        loadingModal.hide();
      });
    }


    function updatePaymentMethodList(paymentType = '', amountPaid = 0, reset = false) {
      if (!reset) {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        listItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <span class="fw-bold" id="paymentType">${paymentType}</span>
                        <div class="d-flex align-items-center">
                            <span class="fw-bold text-danger" id="amountPaid">${numberToBrazilianCurrency(amountPaid)}</span>
                        </div>
                    </div>
                `;
        partialPaymentsList.appendChild(listItem);
        return
      }
      partialPaymentsList.innerHTML = '';
    }

    function clearCart() {
      cart = [];
      localStorage.removeItem('CART');
      document.getElementById('discountInput').value = ''; // Clear discount input field
      discount = 0
      updateShoppingCart();
      updateCartBadge();
    }

    function loadingShimmer() {
      const tbody = document.querySelector('tbody');

      Array.from({ length: 10 }, function (_, i) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
                    <td class="col-3" style="width: 400px; max-width: 400px;">
                        <small>
                            <div class="shimmer" style="height: 1rem; width: 6rem;"></div>
                        </small>
                        <p class="text-truncate mt-2">
                        <div class="shimmer" style="height: 1.25rem; width: 20rem;"></div>
                        </p>
                    </td>
                    <td class="col-auto"><span class="shimmer">
                            <div class="shimmer" style="height: 1rem; width: 4rem;"></div>
                        </span></td>
                    <td class="col-auto"><span class="shimmer">
                            <div class="shimmer" style="height: 1rem; width: 2rem;"></div>
                        </span>
                    </td>
                    <td class="col-auto">
                            <div class="shimmer" style="height: 1.25rem; width: 4rem;"></div>
                        
                    </td>
                `;
        tbody.appendChild(tr);
      })
    }

  </script>
</body>

</html>