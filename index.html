<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      label,
      button,
      span,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: "Montserrat", sans-serif;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
          <h1 class="navbar-brand fw-bold">YAMADA</h1>
        </div>
      </nav>

      <h3 class="text-uppercase text-center my-5">Chamado de Manutenção</h3>
      <form target="_self" id="formularioManutencao">
        <div class="row g-3">
          <div class="col-12">
            <label for="solicitante" class="form-label text-uppercase"
              >Solicitante</label
            >
            <select class="form-select" id="solicitante" required>
              <option selected disabled>Selecionar</option>
            </select>
          </div>
          <div class="col-12">
            <label for="departamento" class="form-label text-uppercase"
              >Departamento</label
            >
            <select class="form-select" id="departamento" required>
              <option selected disabled>Selecionar</option>
            </select>
          </div>
          <div class="col-12">
            <label for="equipamento" class="form-label text-uppercase"
              >Equipamento</label
            >
            <select class="form-select" id="equipamento" required>
              <option selected disabled>Selecionar</option>
            </select>
          </div>
          <div class="col-12">
            <label for="descricao" class="form-label text-uppercase"
              >Descrição</label
            >
            <textarea
              class="form-control"
              rows="3"
              id="descricao"
              style="resize: none"
              required
            ></textarea>
          </div>
          <div class="col-12">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                role="switch"
                value=""
                id="manutencao"
              />
              <label class="form-check-label" for="manutencao">
                Manuntenção preventiva
              </label>
            </div>
          </div>
          <div class="col-12">
            <button
              type="submit"
              class="btn btn-primary w-100 text-uppercase fw-semibold mt-3"
            >
              Abrir
            </button>
          </div>
        </div>
      </form>
    </div>
    <div
      class="modal fade"
      id="loadingModal"
      tabindex="-1"
      aria-labelledby="loadingModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Carregando...</p>
          </div>
        </div>
      </div>
    </div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        id="liveToast"
        class="toast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <strong class="me-auto">Mensagem</strong>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div class="toast-body">
          <p id="toast-message"></p>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const loadingModal = new bootstrap.Modal(
          document.getElementById("loadingModal"),
          {
            backdrop: "static",
            keyboard: false,
          }
        );

        document.addEventListener("DOMContentLoaded", function () {
          loadingModal.show();
          queryFormData();
        });

        document
          .querySelector("#formularioManutencao")
          .addEventListener("submit", function (event) {
            event.preventDefault();

            const solicitanteElement = document.querySelector("#solicitante");
            const departamentoElement = document.querySelector("#departamento");
            const equipamentoElement = document.querySelector("#equipamento");
            const descricaoElement = document.querySelector("#descricao");
            const manutencaoElement = document.querySelector("#manutencao");

            document.querySelectorAll("required").forEach((element) => {
              if (
                !element.value ||
                !element.checked ||
                element.selectedIndex === 0
              ) {
                showToast("Preencha todos os campos", "warning");
                return;
              }
            });

            const solicitante =
              solicitanteElement.options[solicitanteElement.selectedIndex].text;
            const departamento =
              departamentoElement.options[departamentoElement.selectedIndex].text;
            const equipamento =
              equipamentoElement.options[equipamentoElement.selectedIndex].text;
            const descricao = descricaoElement.value;
            const manutencao = manutencaoElement.checked ? "Sim" : "Não";

            const dados = {
              solicitante,
              departamento,
              equipamento,
              descricao,
              manutencao,
            };

            postFormData(dados);
          });

        function queryFormData() {
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(function (response) {
                populateSelectElement("#solicitante", response);
                resolve(response);
              })
              .withFailureHandler(function (error) {
                console.error("Error fetching data:", error);
                reject(error);
              })
              .getSolicitante();
          })
            .then(() => {
              google.script.run
                .withSuccessHandler(function (response) {
                  populateSelectElement("#departamento", response);
                })
                .withFailureHandler(function (error) {
                  console.error("Error fetching data:", error);
                })
                .getDepartamentos();
            })
            .then(() => {
              google.script.run
                .withSuccessHandler(function (response) {
                  populateSelectElement("#equipamento", response);
                })
                .withFailureHandler(function (error) {
                  console.error("Error fetching data:", error);
                })
                .getEquipamentos();
            })
            .finally(() => {
              loadingModal.hide();
            });
        }

        function populateSelectElement(selector, items) {
          const selectElement = document.querySelector(selector);
          selectElement.innerHTML =
            "<option selected disabled>Selecionar</option>";
          items.forEach((item) => {
            const optionElement = document.createElement("option");
            optionElement.value = item;
            optionElement.textContent = item;
            selectElement.appendChild(optionElement);
          });
        }

        function postFormData(data) {
          loadingModal.show();
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(function (response) {
                showToast("Chamado aberto com sucesso", "success");
                document.querySelector("#formularioManutencao").reset();
                resolve(response);
              })
              .withFailureHandler(function (error) {
                console.error("Error posting data:", error);
                showToast("Erro ao abrir chamado", "error");
                reject(error);
              })
              .postFormDataToSheet(data);
          }).finally(() => {
            loadingModal.hide();
          });
        }

        function showToast(message, type) {
          const toast = new bootstrap.Toast(document.getElementById("liveToast"));
          const toastHeader = document.querySelector("#liveToast .toast-header");
          const messageElement = document.querySelector("#toast-message");

          messageElement.textContent = message;
          toastHeader.classList.remove("bg-success", "bg-danger", "bg-warning");
          if (type === "success") {
            toastHeader.classList.add("bg-success");
          } else if (type === "error") {
            toastHeader.classList.add("bg-danger");
          } else if (type === "warning") {
            toastHeader.classList.add("bg-warning");
          }

          toast.show();
        }

        function queryOrdensData() {
          const orderList = document.querySelector("#orders-list")
          orderList.innerHTML = ''

         fetch(
            'https://script.google.com/macros/s/AKfycbyqPmorwLcgrBWHma8vDgDVHHdXAXREbBRDsAX4VBSkpk9ocjdHZU6cKY-R1aI3LJuiQg/exec',
            {
              headers: { 'Access-Control-Allow-Origin': '*' }
            }
          )
         .then( res => res.json())
         .then(data => {
          console.table(data)
          data.forEach(order => {
              orderList.innerHTML += `
                  <div class="accordion accordion-flush" id="orderAccordion">
                      <div class="accordion-item">
                          <h2 class="accordion-header" id="flush-heading${order.id}"></h2>
                          <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                              type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse${order.id}">
                              <div>
                                  <span class="card-title fw-bold">OS</span>
                                  <span class="card-title fw-semibold text-muted" id="order-number">${String(order.id).padStart(9, 0)}</span>
                              </div>
                              <span class="badge bg-primary ms-3" id="order-status">${order.status}</span>
                          </button>
                          </h2>
                          <div id="flush-collapse${order.id}" class="accordion-collapse collapse"
                              aria-labelledby="flush-heading${order.id}" data-bs-parent="#orderAccordion">
                              <div class="accordion-body">
                                  <ul class="list-group list-group-flush">
                                      <li class="list-group-item">
                                          <div>
                                              <h6 class="card-subtitle mb-2 fw-semibold">Solicitante</h6>
                                              <span class="text-muted" id="solicitante">${order.solicitante}</span>
                                          </div>
                                      </li>
                                      <li class="list-group-item">
                                          <div>
                                              <h6 class="card-subtitle mb-2 fw-semibold">Setor</h6>
                                              <span class="text-muted" id="setor">${order.setor}</span>
                                          </div>
                                      </li>
                                      <li class="list-group-item">
                                          <div>
                                              <h6 class="card-subtitle mb-2 fw-semibold">Data</h6>
                                              <span class="text-muted" id="data">${order.data}</span>
                                          </div>
                                      </li>
                                      <li class="list-group-item">
                                          <div>
                                              <h6 class="card-subtitle mb-2 fw-semibold">Equipamento</h6>
                                              <span class="text-muted" id="equipamento">${order.equipamento}</span>
                                          </div>
                                      </li>
                                      <li class="list-group-item">
                                          <div>
                                              <h6 class="card-subtitle mb-2 fw-semibold">Descrição</h6>
                                              <span class="text-muted" id="descricao">${order.descricao}</span>
                                          </div>
                                      </li>
                                  </ul>
                              </div>
                          </div>
                      </div>
                  </div>
          `
          })
         })
      }
    </script>
  </body>
</html>
