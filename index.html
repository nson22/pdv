<!DOCTYPE html>
<html lang="en">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@4.1.0/cdn.min.js"
    integrity="sha256-bDgRIzo3i6VHqJMlDwUcu/g1mnxCoS6B1sNW3269kJY=" crossorigin="anonymous"></script>
</head>

<body>
  <header class="sticky-top">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center w-100">
          <img class="img-fluid"
            src="https://media.licdn.com/dms/image/C4D0BAQH9wt7D8VAgPQ/company-logo_200_200/0/1630004356077?e=2147483647&v=beta&t=Uo0snLYC-0tV095iir9SdTC660uRkqVOLRwliLCpM7c"
            alt="Logo" style="max-width: 60px;">
          <h1 class="navbar-brand m-0 text-center fw-bold fs-4">YAMADA Brasil</h1>
          <button class="btn btn-primary btn-lg fw-semibold" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">
            <i class="bi bi-list"></i>
          </button>
        </div>

        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasExampleLabel">
          <div class="offcanvas-header bg-light">
            <h5 class="offcanvas-title" id="offcanvasExampleLabel">Menu</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <button class="btn btn-primary btn-lg fw-semibold w-100" data-bs-toggle="modal"
                  data-bs-target="#serviceOrderModal">
                  Criar OS
                </button>
              </li>
              <li class="list-group-item">
                <button class="btn btn-primary btn-lg fw-semibold w-100" disabled>
                  Concluídas (TBD)
                </button>
              </li>
              <li class="list-group-item">
                <button class="btn btn-primary btn-lg fw-semibold w-100" disabled>
                  Em progresso (TBD)
                </button>
              </li>
              <li class="list-group-item">
                <button class="btn btn-primary btn-lg fw-semibold w-100" disabled>
                  Canceladas (TBD)
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
      </div>
    </nav>
  </header>

  <main class="container p-1 mt-3">
    <div class="row" id="orders"></div>

    <!-- Toast message -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Mensagem</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
      </div>
    </div>

    <!-- Service orders modal -->
    <div class="modal fade" id="serviceOrderModal" tabindex="-1" aria-labelledby="serviceOrderModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header bg-light">
            <h5 class="modal-title" id="serviceOrderModalLabel">Criar OS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="row">
                <div class="mb-3 col-12 col-lg-12">
                  <i class="bi bi-calendar3 me-2"></i> Data:
                  <span id="currentDate" class="text-uppercase fw-semibold"></span>
                </div>
              </div>
              <div class="row">
                <div class="mb-3 col-12 col-lg-3">
                  <label for="collaborator" class="form-label text-uppercase fw-semibold">Responsável</label>
                  <select class="form-select" id="collaborator" required>
                    <option value="" disabled selected>Selecionar</option>
                  </select>
                </div>
                <div class="mb-3 col-12 col-lg-3">
                  <label for="equipmentStatus" class="form-label text-uppercase fw-semibold">Status do
                    Equipamento</label>
                  <select class="form-select" id="equipmentStatus" required>
                    <option value="" disabled selected>Selecionar</option>
                  </select>
                </div>
                <div class="mb-3 col-12 col-lg-3">
                  <label for="equipment" class="form-label text-uppercase fw-semibold">Equipamento</label>
                  <select class="form-select" id="equipment" required>
                    <option value="" disabled selected>Selecionar</option>
                  </select>
                </div>
                <div class="mb-3 col-12 col-lg-3">
                  <label for="maintainceType" class="form-label text-uppercase fw-semibold">Tipo de Manutenção</label>
                  <select class="form-select" id="maintainceType" required>
                    <option value="" disabled selected>Selecionar</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <div class="mb-3 col-12 col-lg-12">
                  <button type="submit" class="btn btn-primary text-uppercase fw-semibold w-100">
                    </i> Salvar
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Service orders modal history -->
    <div class="modal fade" id="serviceOrderModalHistory" tabindex="-1" aria-labelledby="serviceOrderModalHistoryLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header bg-light">
            <h5 class="modal-title" id="serviceOrderModalHistoryLabel">Histórico da OS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="historyHeader" class="mb-3">

            </div>
            <div class="accordion" id="orderHistoryAccordion">

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Service in progress modal -->
    <div class="modal fade" id="orderStatusModal" tabindex="-1" aria-labelledby="orderStatusModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="orderStatusModalLabel">Atualizar OS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="orderStatusForm">
              <div class="mb-3">
                <label for="orderId" class="form-label text-uppercase fw-semibold">ID da Ordem de Serviço</label>
                <input type="text" class="form-control" id="orderId" readonly disabled>
              </div>
              <div class="mb-3">
                <label for="collaboratorModal" class="form-label text-uppercase fw-semibold">Responsável</label>
                <select class="form-select" id="collaboratorModal" required>
                  <option value="" disabled selected>Selecionar</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="anomaly" class="form-label text-uppercase fw-semibold">Anomalia</label>
                <input type="search" class="form-control" id="anomaly" list="anomalies" required>
                <datalist id="anomalies">
                  <option value="Pms entrando em modo stand by">
                  <option value="setup">
                  <option value="Falha na cortina de segurança">
                  <option value="Agulha quebrada">
              </div>
              <div class="mb-3">
                <label for="action" class="form-label text-uppercase fw-semibold">Ação</label>
                <input type="search" class="form-control" id="action" list="anomalies" required>
                <datalist id="actions">
                  <option value="Preenchido todos os parâmetros">
                  <option
                    value="Após dariedson entregar um conjuto de lamina feito teste em máquina e ajuste liberado para produção">
                  <option value="acompanhamento de linha">
                  <option value="Organização dos documentos das preventivas">
              </div>
              <div class="mb-3">
                <label for="orderStatus" class="form-label text-uppercase fw-semibold">Status</label>
                <select class="form-select" id="orderStatus" required>
                  <option value="" disabled selected>Selecionar</option>
                  <option value="Em progresso">Em progresso</option>
                  <option value="Concluído">Concluído</option>
                  <option value="Cancelar">Cancelar</option>
                </select>
              </div>
              <div class="modal-footer mt-3">
                <button type="submit" class="btn btn-primary w-100 text-uppercase">Atualizar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const maintainceType = ['Corretiva', 'Preventiva', 'Setup', 'Melhoria'];
    const equipments = ['Hot Stamp', 'USW 03/350', 'Máquina 21', 'Wire Aut 04', 'Assembly'];
    const equipmentStatus = ['Não programado', 'Programado', 'Setup'];
    const collaborators = ['Reiciane', 'Pedro', 'Eric', 'Vitor Gabriel'];
    const serviceOrderModal = new bootstrap.Modal(document.getElementById('serviceOrderModal'));
    const orderStatusModal = new bootstrap.Modal(document.getElementById('orderStatusModal'));

    const serviceOrders = new Map();

    document.addEventListener('DOMContentLoaded', () => {
      // const mockOrder = {
      //   id: '000000001',
      //   date: new Date().toLocaleString(),
      //   type: 'Corretiva',
      //   status: [{ orderStatus: 'Aberto', date: new Date().toLocaleString() }],
      //   collaborators: ['Reiciane'],
      //   equipment: 'Hot Stamp',
      //   maintainceType: 'Corretiva',
      //   equipmentStatus: 'Não programado',
      //   anomaly: '',
      //   action: ''
      // };
      // serviceOrders.set(mockOrder.id, mockOrder);
      displayOrders();
    });

    document.getElementById('serviceOrderModal').addEventListener('show.bs.modal', () => {
      populateSelectOptions('collaborator', collaborators);
      populateSelectOptions('equipmentStatus', equipmentStatus);
      populateSelectOptions('equipment', equipments);
      populateSelectOptions('maintainceType', maintainceType);
      document.getElementById('currentDate').textContent = new Date().toLocaleString();
    });

    document.getElementById('serviceOrderModal').addEventListener('hide.bs.modal', resetModal);

    document.querySelector('form').addEventListener('submit', (event) => {
      event.preventDefault();
      const newOrder = createNewOrder();
      serviceOrders.set(newOrder.id, newOrder);
      document.querySelector('form').reset();
      displayOrders();
      serviceOrderModal.hide();
    });

    document.getElementById('orderStatusForm').addEventListener('submit', (event) => {
      event.preventDefault();
      updateOrderStatus();
    });

    function populateSelectOptions(selectId, options) {
      const selectElement = document.getElementById(selectId);
      selectElement.innerHTML = '<option value="" disabled selected>Selecionar</option>';
      options.forEach(option => {
        selectElement.innerHTML += `<option value="${option}">${option}</option>`;
      });
    }

    function resetModal() {
      ['collaborator', 'equipmentStatus', 'equipment', 'maintainceType'].forEach(id => {
        document.getElementById(id).innerHTML = '<option value="" disabled selected>Selecionar</option>';
      });
      document.getElementById('currentDate').textContent = '';
    }

    function createNewOrder() {
      const collaborator = document.getElementById('collaborator').value;
      const equipmentStatus = document.getElementById('equipmentStatus').value;
      const equipment = document.getElementById('equipment').value;
      const maintainceType = document.getElementById('maintainceType').value;
      const currentDate = document.getElementById('currentDate').textContent;

      const orderId = (serviceOrders.size + 1).toString().padStart(9, '0');

      return {
        id: orderId,
        date: currentDate,
        type: maintainceType,
        status: [{ orderStatus: 'Aberto', date: new Date().toLocaleString() }],
        collaborators: [collaborator],
        equipment,
        maintainceType,
        equipmentStatus,
      };
    }

    function updateOrderStatus() {
      document.getElementById("anomaly").value = ''
      document.getElementById("action").value = ''

      const orderId = document.getElementById('orderId').value;
      const newStatus = document.getElementById('orderStatus').value;
      const collaborator = document.getElementById('collaboratorModal').value;
      const order = serviceOrders.get(orderId);

      order.collaborators.push(collaborator);
      order.status.push({ orderStatus: newStatus, date: new Date().toLocaleString() });
      order.anomaly = document.getElementById('anomaly').value;
      order.action = document.getElementById('action').value;

      serviceOrders.set(orderId, order);
      orderStatusModal.hide();
      displayOrders();
    }

    function openOrder(orderId) {
      populateSelectOptions('collaboratorModal', collaborators);
      const order = serviceOrders.get(orderId);
      document.getElementById('orderId').value = order.id;
      document.getElementById('orderStatus').value = order.status;
      orderStatusModal.show();
    }

    function displayOrders() {
      const ordersList = document.querySelector('#orders');
      ordersList.innerHTML = "";

      if (serviceOrders.size === 0) {
        ordersList.innerHTML = '<div class="col-12 d-flex justify-content-center align-items-center mt-5 pt-5"><span class="fw-semibold pt-5 mt-5">Nenhuma ordem de serviço encontrada</span></div>';
        return;
      }

      serviceOrders.forEach((order) => {
        console.log(order);

        ordersList.innerHTML += `
          <div class="col-12 col-lg-6">
            <div class="card mb-2">
              <div class="card-body">
                <div class="row">
                  <div class="col-6 col-lg-8">
                    <h5 class="card-title"><span class="badge bg-primary">OS ${order.id}</span></h5>
                  </div>
                  <div class="col-6 col-lg-4 text-end mb-3">
                    <button type="button" class="text-white btn btn-${changeOrderStatusColor(order.status[order.status.length - 1].orderStatus)} btn-sm" onclick="openOrder('${order.id}')">
                      <i class="bi bi-sliders"></i>
                     ${order.status[order.status.length - 1].orderStatus}
                    </button>
                  </div>
                  <div class="col-8 col-lg-8">
                    <span class="fw-semibold">
                      <i class="bi bi-calendar3 me-2"></i>${order.status[0].date}
                    </span>
                  </div>
                  <div class="col-4 col-lg-4 text-end mb-2">
                    <span class="fw-semibold">${order.type}</span>
                  </div>
                </div>
                <div class="col-12">
                  <button class="btn btn-outline-secondary mt-2 w-100" type="button" data-bs-toggle="modal" data-bs-target="#serviceOrderModalHistory" onclick=orderServiceHistory("${order.id}")>
                     <span class="fw-semibold">Atividades</span>
                  </button>
                </div>
              </div>
            </div>
          </div>`;
      });
    }

    function orderServiceHistory(orderId) {
      const order = serviceOrders.get(orderId);
      const modalTitle = document.querySelector('#serviceOrderModalHistoryLabel');
      const accordion = document.querySelector('#orderHistoryAccordion');
      const historyHeader = document.querySelector('#historyHeader');

      modalTitle.innerHTML = `
        <div class="d-flex align-items-center">
          <h5 class="me-2 mb-0"><span class="badge bg-primary">OS ${order.id}</span></h5>
          </div>
          `;
          
      historyHeader.innerHTML = `
        <ul class="list-group">
          <li class="list-group-item d-flex align-items-center">
            <strong>Ação</strong><span class="ms-2">${order.type}</span>
          </li>
          <li class="list-group-item d-flex align-items-center">
            <strong>Equipamento</strong><span class="ms-2">${order.equipment}</span>
          </li>
          <li class="list-group-item d-flex align-items-center">
            <strong>Tipo</strong><span class="ms-2">${order.maintainceType}</span>
          </li>
          <li class="list-group-item d-flex align-items-center">
            <strong>Status</strong><span class="ms-2">${order.equipmentStatus}</span>
          </li>
        </ul>
      `

      order.status.forEach((status, index) => {
        const isOpen = status.orderStatus.toLowerCase() === 'aberto';

        accordion.innerHTML += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading${index}">
              <button class="accordion-button ${index !== 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="${index === 0}" aria-controls="collapse${index}">
                <span class="badge bg-${changeOrderStatusColor(status.orderStatus)} me-2">${status.orderStatus}</span>
                <small class="text-muted">${order.date}</small>
              </button>
            </h2>
            <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading${index}" data-bs-parent="#orderHistoryAccordion">
              <div class="accordion-body">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex align-items-center">
                    <i class="bi bi-person me-2"></i>
                    <strong class="me-2">Responsável:</strong> ${order.collaborators[index]}
                  </li>
                  ${!isOpen && order.anomaly ? `
                    <li class="list-group-item d-flex align-items-center">
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      <strong class="me-2">Anomalia:</strong> ${order.anomaly}
                    </li>
                  ` : ''}
                  ${!isOpen && order.action ? `
                    <li class="list-group-item d-flex align-items-center">
                      <i class="bi bi-tools me-2"></i>
                      <strong class="me-2">Ação:</strong> ${order.action}
                    </li>
                  ` : ''}
                </ul>
              </div>
            </div>
          </div>
        `;
      });


      //   let historyHTML = '<div class="accordion" id="orderHistoryAccordion">';

      //   order.status.forEach((status, index) => {
      //     const isOpen = status.orderStatus.toLowerCase() === 'aberto';

      //   historyHTML += `
      //   <div class="accordion-item">
      //     <h2 class="accordion-header" id="heading${index}">
      //       <button class="accordion-button ${index !== 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="${index === 0}" aria-controls="collapse${index}">
      //         <span class="badge bg-${changeOrderStatusColor(status.orderStatus)} me-2">${status.orderStatus}</span>
      //         <small class="text-muted">${order.date}</small>
      //       </button>
      //     </h2>
      //     <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading${index}" data-bs-parent="#orderHistoryAccordion">
      //       <div class="accordion-body">
      //         <ul class="list-group list-group-flush">
      //           <li class="list-group-item d-flex align-items-center">
      //             <i class="bi bi-clock me-2"></i>
      //             <strong class="me-2">Tipo:</strong> ${order.type}
      //           </li>
      //           <li class="list-group-item d-flex align-items-center">
      //             <i class="bi bi-person me-2"></i>
      //             <strong class="me-2">Responsável:</strong> ${order.collaborators[index]}
      //           </li>
      //           <li class="list-group-item d-flex align-items-center">
      //             <i class="bi bi-person me-2"></i>
      //             <strong class="me-2">Equipamento:</strong> ${order.equipment}
      //           </li>
      //           <li class="list-group-item d-flex align-items-center">
      //             <i class="bi bi-person me-2"></i>
      //             <strong class="me-2">Equipamento status:</strong> ${order.equipmentStatus}
      //           </li>
      //           ${!isOpen && order.anomaly ? `
      //             <li class="list-group-item d-flex align-items-center">
      //               <i class="bi bi-exclamation-triangle me-2"></i>
      //               <strong class="me-2">Anomalia:</strong> ${order.anomaly}
      //             </li>
      //           ` : ''}
      //           ${!isOpen && order.action ? `
      //             <li class="list-group-item d-flex align-items-center">
      //               <i class="bi bi-tools me-2"></i>
      //               <strong class="me-2">Ação:</strong> ${order.action}
      //             </li>
      //           ` : ''}
      //         </ul>
      //       </div>
      //     </div>
      //   </div>
      // `;
      //   });

      //   historyHTML += '</div>';
      //   modalBody.innerHTML = historyHTML;
    }

    function showToast(message, status) {
      const toast = document.getElementById('liveToast');
      const toastInstance = new bootstrap.Toast(toast);
      const toastMessage = document.getElementById('toastMessage');
      const toastHeader = toast.querySelector('.toast-header');
      toastMessage.textContent = message;
      toastHeader.className = 'toast-header';
      toastHeader.classList.add(`bg-${status}`, 'text-white');
      toastInstance.show();
    }

    function changeOrderStatusColor(status) {
      switch (status) {
        case 'Em progresso':
          return 'warning';
        case 'Concluído':
          return 'success';
        case 'Cancelar':
          return 'danger';
        default:
          return 'primary';
      }
    }
  </script>
</body>

</html>