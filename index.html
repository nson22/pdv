<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PJ Variedades | Tudo para seu lar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>

<body style="font-family: 'Montserrat', sans-serif !important; text-transform: uppercase;">
    <header class="bg-dark py-3 fixed-top">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mb-0 mx-auto"
                        style="width: 100%;">
                        <span class="navbar-brand text-danger fw-bold fs-4 d-block d-md-inline">
                            PJ
                            <span
                                class="text-secondary fw-semibold text-uppercase text-warning d-md-inline">Variedades</span>
                        </span>
                        <div class="d-flex align-items-center flex-grow-1 mx-md-3 my-2 my-md-0">
                            <input class="form-control form-control-lg border border-warning w-100" id="search"
                                data-testid="inputSearchCode" type="search" inputmode="numeric"
                                placeholder="Procurar produto" aria-label="Search">
                            <button class="btn btn-outline-secondary btn-lg border border-0 ms-2" type="button"
                                data-bs-toggle="modal" data-testid="btnCart" id="cart" onclick="openCart()">
                                <div class="position-relative">
                                    <span
                                        class="position-absolute top-0 start-50 translate-middle-y badge rounded bg-danger ms-0">
                                        <small data-testid="badgeCartTotal" id="badge"></small>
                                    </span>
                                    <i class="fa-solid fa-cart-shopping text-warning"></i>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="mt-5 pt-5 mb-5 pb-2 container" id="cardMobile" style="min-height: calc(100vh - 160px);">

    </main>

    <!-- Toast -->
    <div class="position-fixed mb-5 bottom-0 start-50 translate-middle-x p-3" style="z-index: 9999">
        <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-warning">
                <strong class="me-auto text-uppercase">Notificação</strong>
                <button type="button" class="btn-close text-warning" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <p id="paymentAlert"></p>
            </div>
        </div>
    </div>

    <footer class="bg-dark d-flex align-items-center fixed-bottom py-2" data-bs-theme="dark">
        <div class="container text-center">
            <span class="navbar-tex h1 text-warning fw-bold mt-1 mb-1 text-danger">Total: <span class="text-warning"
                    id="total">R$ 0,00</span></span>
        </div>
    </footer>

    <!-- Modal Payment -->
    <div class="modal fade" id="modalPayment" tabindex="-1" aria-labelledby="modalPaymentSearch" aria-hidden="true">
        <div class="modal-dialog modal-md modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark">
                    <h1 class="modal-title text-warning fs-5 text-uppercase" id="modalPaymentSearchLabel">Métodos de
                        pagamento
                    </h1>
                    <button type="button" class="btn-close text-bg-danger me-2" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalPaymentBody">
                    <div class="row" id="payments">
                        <div class="col-3 d-grid mx-auto"> <input type="radio" class="btn-check" data-payment="PIX"
                                data-testid="radioPix" name="payment-options" id="pix-outlined" autocomplete="off"
                                checked>
                            <label class="btn btn-outline-secondary text-warning" for="pix-outlined"><i
                                    class="fa-brands fa-pix"></i><br />PIX</label>
                        </div>
                        <div class="col-3 d-grid mx-auto"><input type="radio" class="btn-check" data-payment="CREDITO"
                                data-testid="radioCredit" name="payment-options" id="credit-outlined"
                                autocomplete="off">
                            <label class="btn btn-outline-secondary text-warning" for="credit-outlined"><i
                                    class="fa-solid fa-credit-card"></i><br />Crédito</label>
                        </div>
                        <div class="col-3 d-grid mx-auto"> <input type="radio" class="btn-check" data-payment="DEBITO"
                                data-testid="radioDebit" name="payment-options" id="debit-outlined" autocomplete="off">
                            <label class="btn btn-outline-secondary text-warning" for="debit-outlined"><i
                                    class="fa-regular fa-credit-card"></i><br />Débito</label>
                        </div>
                        <div class="col-3 d-grid mx-auto"> <input type="radio" class="btn-check" data-payment="DINHEIRO"
                                data-testid="radioMoney" name="payment-options" id="money-outlined" autocomplete="off">
                            <label class="btn btn-outline-secondary text-warning" for="money-outlined"><i
                                    class="fa-solid fa-brazilian-real-sign"></i><br />Dinheiro</label>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="input-group input-group-lg">
                            <div class="input-group input-group-lg mt-3">
                                <span class="input-group-text border-warning bg-warning"><strong>Total</strong></span>
                                <input type="text" class="form-control border-warning" id="paymentTotal" data-currency
                                    placeholder="R$ 0,00" disabled>
                                <span
                                    class="input-group-text border-warning bg-warning"><strong>Desconto</strong></span>
                                <input type="text" class="form-control border-warning" id="paymentDiscount"
                                    data-currency placeholder="R$ 0,00">
                            </div>
                        </div>
                        <div class="input-group input-group-lg mt-3">
                            <span class="input-group-text border-warning bg-warning"><strong>Pago</strong></span>
                            <input type="text" class="form-control border-warning" id="paymentAmoutPayed" data-currency
                                placeholder="R$ 0,00">
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <div class="d-flex justify-content-between w-100">
                        <button type="button" class="btn btn-danger flex-grow-1 me-2"
                            data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success flex-grow-1" id="confirmPayment"
                            onclick="handlePayment()">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Inventory -->
    <div class="modal fade" id="modalInventory" tabindex="-1" aria-labelledby="modalInventorySearch" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark">
                    <h1 class="modal-title text-warning fs-5 text-uppercase" id="modalInventorySearchLabel">Resultado(s)
                        para:
                        <span id="modalHeaderInventory" class="text-danger"></span>
                    </h1>
                    <button type="button" class="btn-close text-bg-danger me-2" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalInventoryBody">
                    <div class="container" id="main">
                        <div class="table-responsive" data-mdb-perfect-scrollbar="true">
                            <table class="table align-middle">
                                <thead class="bg-secondary text-light">
                                    <tr>
                                        <th scope="col" class="text-truncate">PRODUTO</th>
                                        <th scope="col" class="text-center text-truncate">R$ (UNIT)</th>
                                        <th scope="col" class="text-center text-truncate">ADICIONAR</th>
                                    </tr>
                                </thead>
                                <tbody id="modalInventoryTableBody">

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Single Sale-->
    <div class="modal fade" id="modalSingleSale" tabindex="-1" aria-labelledby="modalSingleSaleLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark">
                    <h1 class="modal-title text-warning fs-5 text-uppercase" id="modalSingleSaleLabel">Venda avulsa</h1>
                    <button type="button" class="btn-close text-bg-danger me-1" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row">
                            <div class="col-12">
                                <input class="form-control-lg w-100 border-warning" type="text" name="venda avulsa"
                                    id="singleSaleProduct" placeholder="Nome do produto">
                            </div>
                            <div class="input-group input-group-lg mt-3">
                                <span class="input-group-text border-warning bg-warning"><strong>Preço</strong></span>
                                <input type="text" class="form-control border-warning" id="singleSalePrice"
                                    data-currency placeholder="R$ 0,00">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <div class="d-flex justify-content-between w-100">
                        <button type="button" class="btn btn-danger flex-grow-1 me-2"
                            data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success flex-grow-1"
                            onclick="handleSingleSale()">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
            </script>

        <script>
            let cart = JSON.parse(localStorage.getItem("CART")) || []
            const badgeCartTotalEl = document.querySelector("#badge");
            const totalEl = document.querySelector("#total");
            const cardMobileEl = document.querySelector("#cardMobile");
            const searchCodeEl = document.querySelector("#search")

            const modalInventory = new bootstrap.Modal("#modalInventory")
            const modalInventorySearchEl = document.querySelector("#modalInventorySearch")
            const modalHeaderInventoryEl = document.querySelector("#modalHeaderInventory")
            const modalInventoryTableBodyEl = document.querySelector("#modalInventoryTableBody")

            const modalSingleSale = new bootstrap.Modal("#modalSingleSale")
            const singleSalePriceEl = document.querySelector("#singleSalePrice")
            const singleSaleProductEl = document.querySelector("#singleSaleProduct")

            const modalPayment = new bootstrap.Modal("#modalPayment")
            const paymentTotalEl = document.querySelector("#paymentTotal");
            const paymentAmoutPayed = document.querySelector("#paymentAmoutPayed");

            const dataCurrency = document.querySelectorAll("[data-currency]")

            const toastEl = document.querySelector("#liveToast")
            const toastBodyEL = document.querySelector(".toast-body")
            const toast = new bootstrap.Toast(toastEl)

            let total = Number(cart.reduce((sum, item) => sum + (item.price * item.amount), 0).toFixed(2));
            let isInstallments = false
            let remainingAmount = 0

            window.addEventListener("load", function () {
                const storedCart = JSON.parse(localStorage.getItem("CART"));

                if (storedCart && storedCart.length > 0) {
                    cart = storedCart;
                    badgeCartTotalEl.textContent = cart.length;

                    totalEl.textContent = numberToBrazilianReal(total)

                    cardMobileEl.innerHTML = "";

                    cart.forEach(product => {
                        renderProductOnCard(product);
                    });
                } else {
                    badgeCartTotalEl.textContent = cart.length;
                    updateEmptyCartDisplay();
                    window.addEventListener('DOMContentLoaded', updateEmptyCartDisplay);
                    window.addEventListener('load', updateEmptyCartDisplay);
                    window.addEventListener('beforeunload', updateEmptyCartDisplay);
                }
            });



            cardMobileEl.addEventListener("change", function (event) {
                if (event.target.matches("input[type='number']")) {
                    const productId = parseInt(event.target.dataset.testid.split('-')[1]);
                    const newAmount = event.target.value;
                    updateProductAmount(productId, newAmount);
                }
            });

            searchCodeEl.addEventListener("keypress", async function (e) {
                if (e.key === "Enter") {
                    let query = e.target.value

                    if (query === "") {
                        modalSingleSale.show()
                    } else {
                        // Show loading modal
                        addProductToCartByModal([])
                        modalInventory.show();

                        try {
                            const products = await new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getProductByQueryGS(query);
                            });

                            addProductToCartByModal(products);
                            if (modalInventory._isShown) {
                                modalHeaderInventoryEl.textContent = query;
                            }
                        } catch (error) {
                            console.log(error.message);
                            // Hide loading modal in case of error
                            modalInventory.hide();
                        }
                    }
                    e.target.value = ""
                }
            })

            dataCurrency.forEach((input) => {
                input.addEventListener("input", function (e) {
                    formatToBrazilianRealCurrency(e)
                })
            })

            paymentDiscount.addEventListener("input", function (e) {
                debugger
                const discountValue = brazilianCurrencyToNumber(e.target.value) || 0;
                const discountedTotal = total - discountValue;

                if (discountedTotal >= 0) {
                    totalEl.textContent = numberToBrazilianReal(discountedTotal);
                    paymentTotalEl.value = numberToBrazilianReal(discountedTotal);
                }

                formatToBrazilianRealCurrency(e);
            });

            function updateEmptyCartDisplay() {
                cardMobileEl.innerHTML = `
                            <div class="position-absolute top-50 start-50 translate-middle text-center text-secondary opacity-25">
                                <i class="fas fa-shopping-bag fa-10x"></i>
                                <p class="mt-3 fs-4">Seu carrinho está vazio</p>
                            </div>
                        `;
            }

            function updateProductAmount(productId, newAmount) {
                const product = cart.find(item => item.id === productId);
                if (product) {
                    product.amount = parseInt(newAmount);
                    updateCart();
                }
            }

            function updateCart() {
                cart.forEach(item => {
                    let amountEl = document.querySelector(`[data-testid="amount-${item.id}"]`);
                    let subtotalEl = document.querySelector(`[data-testid="subtotal-${item.id}"]`);

                    if (amountEl) amountEl.value = item.amount;
                    if (subtotalEl) subtotalEl.textContent = numberToBrazilianReal(item.amount * item.price);
                });

                total = cart.reduce((sum, item) => sum + item.amount * item.price, 0);

                totalEl.textContent = numberToBrazilianReal(total);

                badgeCartTotalEl.textContent = cart.length;
                localStorage.setItem("CART", JSON.stringify(cart));
            }

            function handleAddProductToCart(code, name, price) {
                if (code === "" || code === 1) {
                    code = "AVULSA"
                }

                let product = {
                    id: Date.now(),
                    code,
                    name,
                    amount: 1,
                    price
                }

                let alreadyInCart = cart.some(product => {
                    return product.name === name
                })

                if (!alreadyInCart) {
                    cart.push(product)
                    badgeCartTotalEl.textContent = cart.length
                    localStorage.setItem("CART", JSON.stringify([...cart]))
                    renderProductOnCard(product)
                } else {
                    cart = cart.map(item => {
                        if (item.name === name) {
                            return { ...item, amount: item.amount + 1 }
                        }
                        return item
                    })
                }
                updateCart()
            }

            function renderProductOnCard(product) {
                cardMobileEl.innerHTML += `
                 <div class="row mt-5 mt-md-0 mt-lg-0" data-testid="cardId-${product.id}">
                        <div class="col-12">
                            <div class="card mb-0 mb-md-0 mb-lg-3 mx-auto" style="width: 100%;">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="d-flex">
                                        <span class="fw-bold">Código</span>
                                        <kbd class="ms-2" data-testid="${product.id}">${product.code}</kbd>
                                    </div>
                                    <button type="button" class="btn btn-outline-danger btn-sm"
                                        onclick="handleRemoveItemFromCart(${product.id})">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                <div class="card-body d-flex flex-column flex-md-row align-items-start">
                                    <div class="container">
                                        <div class="row mb-2">
                                            <div class="col-12 col-md-12 col-lg-9 mb-3">
                                                <span class="fw-bold text-truncate d-block" data-testid="${product.name}"
                                                    style="overflow: hidden; white-space: nowrap;">${product.name}</span>
                                            </div>
                                            <div class="col-12 col-md-12 col-lg-3">
                                                <div class="d-flex flex-column flex-md-row align-items-start" style="flex: 20%;">
                                                    <div class="input-group w-100">
                                                        <label class="input-group-text border-warning bg-warning fw-bold" for="inputProductAmout">QTD</label>
                                                        <input class="form-control border-warning" type="number" value=${product.amount} min="1" data-testid="amount-${product.id}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="container text-center">
                                        <div class="row">
                                            <div class="col m-2">
                                                <span >Preço (UNIT):</span>
                                                <span class="fw-bold "data-testid="priceUnit-${product.id}">${numberToBrazilianReal(product.price)}</span>
                                            </div>
                                            <div class="col m-2">
                                                <span >Subtotal:</span>
                                                <span class="fw-bold "data-testid="subtotal-${product.id}">${numberToBrazilianReal(product.price * product.amount)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`

            }

            function handleSingleSale() {
                let name = singleSaleProductEl.value
                let price = singleSalePriceEl.value

                if (name === "") {
                    singleSaleProductEl.focus()
                    return
                }

                if (price === "") {
                    singleSalePriceEl.focus()
                    return
                }

                handleAddProductToCart("", name, brazilianCurrencyToNumber(price))
                modalSingleSale.hide()
                name = ""
                price = ""
            }

            function handleRemoveItemFromCart(id) {
                const rowEl = document.querySelector(`[data-testid="cardId-${id}"]`)
                rowEl.remove()

                cart = cart.filter((item) => item.id != id);
                badgeCartTotalEl.textContent = cart.length
                localStorage.setItem("CART", JSON.stringify([...cart]));
                updateCart()
            }

            function openCart() {
                if (cart.length === 0) {
                    toastMessage("Não há itens no carrinho.")
                    return
                }
                modalPayment.show();
            }

            async function handlePayment() {

                let id = Date.now()

                if (!isInstallments) {
                    paymentTotalEl.value = numberToBrazilianReal(total);
                }

                const payment = {
                    id,
                    products: cart.map(product => ({
                        code: product.id,
                        name: product.name,
                        amount: product.amount,
                        price: product.price
                    })),
                    discount: brazilianCurrencyToNumber(paymentDiscount.value) || 0
                }

                let amountPayed = brazilianCurrencyToNumber(paymentAmoutPayed.value) + payment.discount

                if (payment.discount > 0) {
                    total -= payment.discount;
                    paymentTotalEl.value = numberToBrazilianReal(total);
                }

                if (amountPayed > total) {
                    toastMessage("O valor de pagamento excede o valor da venda, portanto o valor foi ajustado.")
                    paymentAmoutPayed.value = numberToBrazilianReal(total);
                    amountPayed = total;
                    return
                }

                if (total === amountPayed) {
                    let paymentType = addPaymentMethod()

                    payment.paymentsMethods = [
                        {
                            id,
                            paymentType,
                            amountPayed
                        }
                    ];

                    postPayment(payment)

                    return;
                }

                if (total > amountPayed) {
                    isInstallments = true

                    remainingAmount = total - amountPayed;
                    let paymentType = addPaymentMethod();

                    payment.paymentsMethods = [
                        {
                            id,
                            paymentType,
                            amountPayed
                        }
                    ];

                    while (remainingAmount > 0) {
                        paymentTotalEl.value = numberToBrazilianReal(remainingAmount);
                        total = numberToBrazilianReal(remainingAmount)
                        paymentAmoutPayed.value = "";
                        modalPayment.show();

                        await new Promise(resolve => {
                            const confirmButton = document.querySelector("#confirmPayment");
                            confirmButton.addEventListener("click", resolve, { once: true });
                        });

                        let partialPayment = brazilianCurrencyToNumber(paymentAmoutPayed.value);

                        if (partialPayment > remainingAmount) {
                            toastMessage("O valor de pagamento excede o valor restante, portanto o valor foi ajustado.");
                            partialPayment = remainingAmount;
                        }

                        remainingAmount -= partialPayment;

                        paymentType = addPaymentMethod();

                        payment.paymentsMethods.push({
                            id,
                            paymentType,
                            amountPayed: partialPayment
                        });
                    }

                    postPayment(payment)

                    return
                }

                //Enviar pagamento para a planilha
            }

            function postPayment(payment) {
                paymentTotalEl.value = ""
                paymentAmoutPayed.value = ""
                removeAllItemFromCart()
                modalPayment.hide();

                google.script.run.postPayment(payment);

            }

            function addProductToCartByModal(products) {
                modalInventoryTableBodyEl.innerHTML = ""

                if (products.length === 0) {
                    Array.from({ length: 10 }, function () {
                        modalInventoryTableBodyEl.innerHTML += `
                    <tr>
                      <div class="row">
                        <td>
                          <div class="progress
                          ">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-secondary" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
                          </div>
                        </td>
                        <td>
                          <div class="progress ">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-secondary" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
                          </div>
                        </td>
                        <td>
                          <div class="progress ">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-secondary" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
                          </div>
                        </td>
                      </div>
                    </tr>
                    `
                    })
                }

                products.forEach(product => {
                    let [code, name, price] = product

                    let sanitizedName = sanitize(name)

                    modalInventoryTableBodyEl.innerHTML += `
                    <tr>
                      <td class="text-uppercase text-truncate">${name}</td>
                      <td class="text-center text-truncate">${numberToBrazilianReal(1 * price)}</td>
                      <td class="text-center">
                          <button type="button" class="btn btn-outline-success btn-sm" onclick="handleAddProductToCart('${code}', '${sanitizedName}', ${price})"><i class="fa-solid fa-plus"></i></button>
                      </td>
                    </tr>
                    `
                })
            }

            function numberToBrazilianReal(number) {
                return number.toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                });
            }

            function brazilianCurrencyToNumber(currency) {
                if (!currency.includes("R$")) {
                    currency = `R$ ${currency}`
                }
                let cleanValue = currency.replace("R$", "").trim();
                cleanValue = cleanValue.replace(/\./g, "");
                cleanValue = cleanValue.replace(",", ".");
                return parseFloat(cleanValue);
            }

            function sanitize(inputText) {
                return inputText
                    .trim()
                    .replace(/\s+/g, ' ')
                    .replace(/'/g, '\\\'') // Escape single quotes
                    .replace(/"/g, '&quot;') // Escape double quotes
            }

            function formatToBrazilianRealCurrency(e) {
                let value = e.target.value;
                value = value.replace(/\D/g, "");
                value = (value / 100).toFixed(2) // Add decimal places
                    .replace(".", ",")           // Replace decimal point with comma
                    .replace(/\B(?=(\d{3})+(?!\d))/g, "."); // Add thousands separator
                e.target.value = value ? `R$ ${value}` : "";
            }

            function removeAllItemFromCart() {
                cart.forEach((item) => {
                    let rowEl = document.querySelector(`[data-testid="cardId-${item.id}"]`)
                    rowEl.remove()

                })

                cart = []
                badgeCartTotalEl.textContent = cart.length
                localStorage.setItem("CART", JSON.stringify([...cart]));

                updateCart()
            }

            function addPaymentMethod() {
                let paymentoMethods = document.querySelectorAll(`[data-testid*="radio"]`);

                let checkedRadio = Array.from(paymentoMethods).find(radio => radio.checked);

                return checkedRadio ? checkedRadio.dataset.payment : null;
            }

            function toastMessage(message) {
                const paymentAlertEl = document.getElementById("paymentAlert");
                paymentAlertEl.innerHTML = `
                  ${message}
                `;
                toast.show();
            }

            //Test Functions
            async function getProducts(query) {
                return await google.script.run.withSuccessHandler(function (products) {
                    return products
                }).withFailureHandler(function onFailure(error) {
                    console.log(error.message)
                }).getProductByQueryGS(query)

                // const inventory = [
                //     ['7896396109181', 'TOALHA DE GELADEIRA COM 3 PÇS REF 918', 5.00],
                //     ['7896396106159', 'CORTINA DE BOX POLIETILENO ESTAMPADA', 8.00],
                //     ['7896873192866', 'CORTINA PARA BOX PEVA (MODELO SOERTIDO)', 33.00],
                //     ['7896873192675', 'CORTINA PARA BOX POLIESTER', 54.00],
                //     ['7890785764487', 'CORTINA DE BANO', 20.00],
                //     ['7899653780178', 'ESPAYULA RETA 5" 24,5 CM ORIGINAL', 20.00],
                //     ['7891112123991', 'RALADOR TRAMONTINA', 17.00],
                //     ['7899653781212', 'ACENDEDOR FOGÃO', 9.00],
                //     ['7898505874737', 'CONJUNTO PARA COZINHA SET 3PÇS', 18.00],
                //     ['7899631629185', 'FORMA DE SILICONE PARA GELO - FRUTAS', 16.90],
                //     ['7899206167500', 'FURADOR DE COCO 10CMX 13CM BESTFER', 13.00],
                //     ['7899653780987', 'FURADOR DE COCO AÇO INOX 13CM ORIGINAL', 13.00]
                // ];

                // return inventory.filter(item =>
                //     item[0].includes(query) ||  // Check if the code (index 0) includes the query
                //     sanitize(item[1]).toLowerCase().includes(sanitize(query).toLowerCase()) // Check if the sanitized name (index 1) includes the sanitized query
                // ).sort((a, b) => b[2] - a[2]); // Sort by price (index 2) in descending order
            }
        </script>
</body>

</html>